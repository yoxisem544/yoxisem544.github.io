{"componentChunkName":"component---src-templates-blog-post-js","path":"/lets-talk-about-oauth-refresh-token/","webpackCompilationHash":"66ccb387adbf71ab8d97","result":{"data":{"site":{"siteMetadata":{"title":"Hello Swift!","author":"David Lin"}},"markdownRemark":{"id":"e7addfd0-7a5e-5e82-b1c0-f6682c5c9c70","html":"<h1 id=\"what-is-oauth\"><a href=\"#what-is-oauth\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is OAuth?</h1>\n<p>網路上關於 OAuth 2.0 的文章很多，包含 Facebook 的 access token 也是類似這樣的機制，這邊不贅述了。</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>可以參考：(關於OAuth 2.0-以Facebook為例 - Justin Lee)(<a href=\"https://medium.com/@justinlee_78563/%E9%97%9C%E6%96%BCoauth-2-0-%E4%BB%A5facebook%E7%82%BA%E4%BE%8B-6f78a4a55f52\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://medium.com/@justinlee_78563/%E9%97%9C%E6%96%BCoauth-2-0-%E4%BB%A5facebook%E7%82%BA%E4%BE%8B-6f78a4a55f52</a>)</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<h2 id=\"當-access-token-過期\"><a href=\"#%E7%95%B6-access-token-%E9%81%8E%E6%9C%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>當 Access Token 過期</h2>\n<p>Access Token 在某些情況下會失效</p>\n<ul>\n<li>Server 主動 revoke access token</li>\n<li>Access token 超過可以運作的時效（過期）</li>\n</ul>\n<p>這時我們就要拿 refresh token 去向 server 換取一組新的 access token 跟 refresh token。</p>\n<h2 id=\"使用-refresh-token-換取新的-access-token\"><a href=\"#%E4%BD%BF%E7%94%A8-refresh-token-%E6%8F%9B%E5%8F%96%E6%96%B0%E7%9A%84-access-token\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用 refresh token 換取新的 access token</h2>\n<p><strong>什麼情況下我們會想要使用 refresh token 去換一組新的 access token 呢？</strong></p>\n<ol>\n<li>也許是 access token 快過期的時候</li>\n<li>或是 api response 回了 401 403 之類 unauth 的 error code 給我們的時候</li>\n</ol>\n<p><strong>而使用 refresh token 去換一組新的 access token，可能要注意：</strong></p>\n<ol>\n<li>手機是否有網路，已經失敗的 api 是不是要 retry？</li>\n<li>是不是要在 api 取得 401 403 error code 時觸發 refresh token 機制？</li>\n<li>refresh token 一次只能執行一次（同一組 refresh token 換兩次 access token 會掛掉）</li>\n</ol>\n<hr>\n<h1 id=\"情況如此複雜，我們如何處理-token-refresh-機制？\"><a href=\"#%E6%83%85%E6%B3%81%E5%A6%82%E6%AD%A4%E8%A4%87%E9%9B%9C%EF%BC%8C%E6%88%91%E5%80%91%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86-token-refresh-%E6%A9%9F%E5%88%B6%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>情況如此複雜，我們如何處理 token refresh 機制？</h1>\n<p>其實要處理以上的狀況並不會太難，首先需要先確保你能實作以下兩個輔助機能：</p>\n<h2 id=\"1-api-call-必須要能-retry\"><a href=\"#1-api-call-%E5%BF%85%E9%A0%88%E8%A6%81%E8%83%BD-retry\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. api call 必須要能 retry</h2>\n<p>當 api 取得 401 403 error code 時，我們需要觸發 refresh 機制，同時把失敗的 api call 放到 retry pool 中，等到 refresh 完成後，再重新執行一次。</p>\n<h2 id=\"2-api-call-必須能被暫停\"><a href=\"#2-api-call-%E5%BF%85%E9%A0%88%E8%83%BD%E8%A2%AB%E6%9A%AB%E5%81%9C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. api call 必須能被暫停</h2>\n<p>當 refresh 機制運作中，所有的 api call 都要被暫停住，等到 refresh 完成後才放行。</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>沒有網路的狀況 api call 以及 refresh 機制都無法動作，所以不會在沒有網路的狀態下將使用者登出。因為無從得知 access token &#x26; refresh token 雙雙失效。（只有在 refresh token 也失效的狀態下，才需要將使用者登出）</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>我們來看如果某一個 api 回了 403 給我們，會發生什麼事</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5511c26f352dcfd8cdd6823c75d7e7d/c3748/api-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 33.292231812577064%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAArElEQVQoz61Ruw7CMAzM//8KCyMLn8DAiFgYaCu1UNJH0sRJfKTJUDEgQMXSSZYfZ/sskI2xzlI/M1tR1w1fixJKaRjroLSBnuxPaOUA70MiFUopSNmxtYQQYzHxJXyuD2FegkPmY7HmTsevSsWTIYgIxhh2zqXJzvmP8JFnLCqcDkfIfpxjy4b39sFFWaHrBxD5pMlk3kNHjSl2njdbXHZ72Og3t27R8M9fDk/7KCYFR1mzTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"refresh-1\"\n        title=\"\"\n        src=\"/static/d5511c26f352dcfd8cdd6823c75d7e7d/b9e4f/api-1.png\"\n        srcset=\"/static/d5511c26f352dcfd8cdd6823c75d7e7d/cf440/api-1.png 148w,\n/static/d5511c26f352dcfd8cdd6823c75d7e7d/d2d38/api-1.png 295w,\n/static/d5511c26f352dcfd8cdd6823c75d7e7d/b9e4f/api-1.png 590w,\n/static/d5511c26f352dcfd8cdd6823c75d7e7d/f9b6a/api-1.png 885w,\n/static/d5511c26f352dcfd8cdd6823c75d7e7d/2d849/api-1.png 1180w,\n/static/d5511c26f352dcfd8cdd6823c75d7e7d/c3748/api-1.png 1622w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>依照上面的設計思路，我們會暫停 api call thread，同時處發 refresh 機制還有 retry 失敗的 api call</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bc07ee4c0d410c61def9a56212dddf8e/8fde6/api-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.21085080147966%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABPklEQVQoz52Q6U7CQBSF+/6vow8AMcYl0HSlFNQugNBQIortdJs53rmUGhPjDyf5epe5y+kYOB+F/x/uVXTIHI0s26v15hVlKSCqBkVZoRR1T8Wxpq5bpPkBo3A+1ImqxvGjwKkQgyBDCIHT6VN1XQe9Q9JHDQzrufhYllhkO05KKbmmaTtFXEQqQ/aNXSfR0lA9mK0EGrHDW55gt39HQWovD9PSpex7NJfhrNAPU9izCB5ZP1yxPUP+PIZLTG4tOM4S3mJFcQo3iDG9d+AFMcczyvcqYZjuMx7MUJneC6xZDMv/iR0kuLka4fHOhU3NOjatJcbXY5j2E6ZepCw/QtO0WqIynCBRNg3SWL/A+SBlf+o8Y0LwskD/WcK+SzPqpj0rXG8PSDd7lW5ybf8kXmWIiO8c96j1NtfvrhVmXxf+WUp0EPw7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"refresh-2\"\n        title=\"\"\n        src=\"/static/bc07ee4c0d410c61def9a56212dddf8e/b9e4f/api-3.png\"\n        srcset=\"/static/bc07ee4c0d410c61def9a56212dddf8e/cf440/api-3.png 148w,\n/static/bc07ee4c0d410c61def9a56212dddf8e/d2d38/api-3.png 295w,\n/static/bc07ee4c0d410c61def9a56212dddf8e/b9e4f/api-3.png 590w,\n/static/bc07ee4c0d410c61def9a56212dddf8e/8fde6/api-3.png 811w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>即使在 refresh 時會花 10 秒鐘的時間去取得新的 access token &#x26; refresh token，且在這個期間又有新的 api call 觸發，所有的 api call（新的 or 失敗重試的），都會等到 refresh 完成後才開始動作。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/8fde6/api-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.21085080147966%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABJ0lEQVQoz51Ry0rDQBTN/y9c6UZw5Qe48QNEFAouLFm4aEFbqDZJa97zfhzvTNKAtig4cLiTk5lzz5mbYFge/1/xrqdFpU7yYuc371twISCkBueS9mqEjGDEaWWwKSvcLxdQ2sT/Qio0LUPPxGQo4ZyjbTtvjIFzDpaqNXaozhOHkbf42JeYr9axqbWWeB/EfWgwmvTJr2HcJ8rdClnZQ1ADzjgUiXUdO87tB5OJoKhd10NbB1bssX2cYT9Pkc2ewOsakpzk6QuatzXILHRwT2eDK00IsZUyk2hS1Q2yLPeCDlbLVzyfXSC9ukZ6fol2W8QXX9zcYn33AEt7QW8qlY4Igm3Pfc/kt8hHEzY/voOQ+2PSU+RJmoiIMAUM9cBhhD+Ng1io+Re5jW78Si395gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"refresh-3\"\n        title=\"\"\n        src=\"/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/b9e4f/api-4.png\"\n        srcset=\"/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/cf440/api-4.png 148w,\n/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/d2d38/api-4.png 295w,\n/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/b9e4f/api-4.png 590w,\n/static/a7da5cc61e0c35f39ea94ef52ae0ee9d/8fde6/api-4.png 811w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<hr>\n<h1 id=\"來看點-code-吧\"><a href=\"#%E4%BE%86%E7%9C%8B%E9%BB%9E-code-%E5%90%A7\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>來看點 Code 吧</h1>\n<h2 id=\"關於-retry\"><a href=\"#%E9%97%9C%E6%96%BC-retry\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>關於 Retry</h2>\n<p>我使用了 PromiseKit 來幫我處理 callback 問題，同時 PromiseKit 也能處理 <a href=\"https://github.com/mxcl/PromiseKit/blob/master/Documentation/CommonPatterns.md#retry--polling\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">retry</a> 的部分</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> attempt<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>maximumRetryCount<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> delayBeforeRetry<span class=\"token punctuation\">:</span> <span class=\"token builtin\">DispatchTimeInterval</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token function\">seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">_</span> body<span class=\"token punctuation\">:</span> @escaping <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> attempts <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function\">attempt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        attempts <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>recover <span class=\"token punctuation\">{</span> error <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">guard</span> attempts <span class=\"token operator\">&lt;</span> maximumRetryCount <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">throw</span> error <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">after</span><span class=\"token punctuation\">(</span>delayBeforeRetry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>on<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> attempt<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">attempt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">attempt</span><span class=\"token punctuation\">(</span>maximumRetryCount<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">yourApiGoesHere</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// api 是個 promise</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>then <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//…</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">_</span> <span class=\"token keyword\">in</span>\n    <span class=\"token comment\">// we attempted three times but still failed</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>如果使用 Rx 的話，就要使用 <a href=\"https://github.com/RxSwiftCommunity/RxSwiftExt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RxSwiftExt</a> 提供的 retry 方法（原本 Rx 提供的 retry 並沒有辦法等待一段時間才重試，不符合我們的需求）</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<h2 id=\"關於-api-call-暫停\"><a href=\"#%E9%97%9C%E6%96%BC-api-call-%E6%9A%AB%E5%81%9C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>關於 api call 暫停</h2>\n<p>這邊相對簡單很多，<code class=\"language-text\">DispatchQueue</code> 提供我們一個可以暫停 thread 的方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> requestQueue<span class=\"token punctuation\">:</span> <span class=\"token builtin\">DispatchQueue</span> <span class=\"token operator\">=</span> <span class=\"token function\">DispatchQueue</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">:</span> <span class=\"token string\">\"com.hello.request_queue\"</span><span class=\"token punctuation\">)</span>\nrequestQueue<span class=\"token punctuation\">.</span><span class=\"token function\">suspend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 暫停 thread</span>\nrequestQueue<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 重新啟動 thread</span></code></pre></div>\n<p>於是我們可以把所有的 api call 放到該 thread 執行，當 refresh 機制一被觸發，就可以把該 thread 暫停住。（記得不要把 refresh 機制也放到該 thread 中了，不然 refresh 永遠不會成功）</p>\n<hr>\n<h1 id=\"結語\"><a href=\"#%E7%B5%90%E8%AA%9E\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結語</h1>\n<p>看到這邊會不會覺得很困惑，為什麼沒有提到太多程式面的部分呢？這就要取決於你的網路層是怎麼建構的了，以上的條件都必須滿足，才會比較好做到上面講的 refresh 機制。</p>\n<p>會使用 PromiseKit 的原因不外乎就是可以解決 callback 問題，且如果你的 api call 被包成 promise 後，要再加上 retry 機制相對就簡單很多了。</p>\n<p>再來我會使用 <a href=\"https://github.com/Moya/Moya\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Moya</a> 來輔助我做 refresh 機制，他的 <a href=\"https://github.com/Moya/Moya/blob/master/docs/Plugins.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">plugin 機制</a>允許我們對一個 request 做預處理或後處理（pre/post process），這樣的好處在於，如果我的 api call 拿到 401 403 等錯誤後，我馬上能觸發 refresh 機制，並且同時 suspend request thread 暫停所有的 api call。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function\">didReceive</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> result<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Result</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Moya</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">Response</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">MoyaError</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">:</span> <span class=\"token builtin\">TargetType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// check 401 403 here</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<p>參考資料：</p>\n<ul>\n<li><a href=\"https://github.com/Moya/Moya/blob/master/docs/Authentication.md#oauth\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Moya OAuth</a></li>\n<li><a href=\"https://github.com/trivago/Heimdallr.swift\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Trivago Heimdallr</a></li>\n</ul>","timeToRead":4,"frontmatter":{"title":"Let's talk about OAuth Refresh Token","date":"September 08, 2019","spoiler":"How can we deal with OAuth refresh token on iOS?"},"fields":{"slug":"/lets-talk-about-oauth-refresh-token/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/lets-talk-about-oauth-refresh-token/","previous":{"fields":{"slug":"/testing-file/","langKey":"en","directoryName":"testing-file","maybeAbsoluteLinks":["/testing-file/"]},"frontmatter":{"title":"Testing File"}},"next":{"fields":{"slug":"/exponential-retry/","langKey":"en","directoryName":"exponential-retry","maybeAbsoluteLinks":[]},"frontmatter":{"title":"How to implement exponential retry?"}},"translations":[],"translatedLinks":[]}}}